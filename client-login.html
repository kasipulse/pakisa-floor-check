<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Client Login</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #0a2b52;
    padding: 40px;
    color: #fff;
  }

  .login-box {
    background: #fff;
    color: #000;
    padding: 25px;
    max-width: 400px;
    border-radius: 8px;
    margin: auto;
  }

  h2 { text-align: center; }

  label { display: block; margin-top: 15px; font-weight: bold; }

  select, input, button {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  select, option { color: #000; background: #fff; }

  button {
    background: #409dbc;
    color: #fff;
    border: none;
    cursor: pointer;
    margin-top: 20px;
  }

  button:hover { opacity: 0.9; }

  .error { color: red; margin-top: 10px; font-size: 13px; }
</style>
</head>
<body>

<div class="login-box">
  <h2>Client Login</h2>

  <label for="companySelect">Company</label>
  <select id="companySelect">
    <option value="">Loading companies...</option>
  </select>

  <label>Password</label>
  <input type="password" id="password">

  <button onclick="login()">Login</button>
  <div id="errorMsg" class="error"></div>
</div>

<script>
  // ðŸ”‘ Firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyBh-KhkmZrS6b97MPv-YTMjU6qTF0qFzbY",
    authDomain: "pakisa-floor.firebaseapp.com",
    databaseURL: "https://pakisa-floor-default-rtdb.firebaseio.com",
    projectId: "pakisa-floor",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const companySelect = document.getElementById("companySelect");
  const errorMsg = document.getElementById("errorMsg");

  // Load companies dynamically
  db.ref("companies").once("value")
    .then(snapshot => {
      const data = snapshot.val();
      companySelect.innerHTML = '<option value="">Select company</option>';

      if (!data) {
        errorMsg.textContent = "No companies found in the database.";
        return;
      }

      Object.keys(data).forEach(key => {
        const company = data[key];
        const option = document.createElement("option");
        option.value = key;
        option.textContent = company.company || company.name || "Unnamed Company";
        companySelect.appendChild(option);
      });

      // âœ… Check if a company is already logged in
      const loggedIn = JSON.parse(localStorage.getItem("loggedInCompany"));
      if (loggedIn) {
        companySelect.value = loggedIn.id;
        companySelect.disabled = true; // prevent changing company
      }
    })
    .catch(err => {
      console.error("Error loading companies:", err);
      errorMsg.textContent = "Failed to load companies.";
    });

  function login() {
    errorMsg.textContent = "";
    const companyId = companySelect.value;
    const password = document.getElementById("password").value.trim();

    if (!companyId || !password) {
      errorMsg.textContent = "Select a company and enter password.";
      return;
    }

    // Get the full company record from Firebase
    db.ref(`companies/${companyId}`).once("value")
      .then(snap => {
        const companyData = snap.val();
        if (!companyData) {
          errorMsg.textContent = "Company not found.";
          return;
        }

        if (companyData.password === password) {
          // âœ… Save to localStorage
          localStorage.setItem("loggedInCompany", JSON.stringify({
            id: companyId,
            name: companyData.company || companyData.name
          }));

          // âœ… Redirect based on role
          if (companyData.role === "client") {
            window.location.href = "client-login.html"; // client-only page
          } else if (companyData.role === "admin") {
            window.location.href = "floor.html"; // admin page
          } else {
            errorMsg.textContent = "Role not recognized.";
          }
        } else {
          errorMsg.textContent = "Incorrect password.";
        }
      })
      .catch(err => {
        console.error("Login error:", err);
        errorMsg.textContent = "Error verifying login.";
      });
  }
</script>

</body>
</html>
