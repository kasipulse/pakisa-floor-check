<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Client Floor Check</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Export libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background: #f5f7fa; padding: 20px; color: #1f2937; }
  .container { max-width: 900px; margin: 0 auto; }
  .card { background: #fff; padding: 18px; border-radius: 12px; box-shadow: 0 6px 24px rgba(15,23,42,0.06); }
  header { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
  h1 { margin:0; font-size:20px; color:#0a2b52; }
  label { font-weight:600; font-size:13px; margin-top:12px; display:block; }
  input, select { width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px; }
  .list { margin-top:12px; }
  .item { padding:12px; border-radius:10px; background:#fff; border:1px solid #eef2f7; margin-bottom:8px; }
  .buttons { margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
  button { padding:10px 14px; border:none; border-radius:8px; background:#409dbc; color:#fff; cursor:pointer; }
  button:hover { opacity:0.9; }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <header>
      <h1>Client Floor Check</h1>
    </header>

    <label for="searchFilter">Search</label>
    <input type="text" id="searchFilter" placeholder="Waybill / Reason" oninput="applyFilters()">

    <label for="startDate">Start Date</label>
    <input type="date" id="startDate" onchange="applyFilters()">

    <label for="endDate">End Date</label>
    <input type="date" id="endDate" onchange="applyFilters()">

    <!-- ✅ Moved export buttons above the scans list -->
    <div class="buttons">
      <button onclick="exportExcel()">Export Excel</button>
      <button onclick="exportPDF()">Export PDF</button>
    </div>

    <h3 style="margin-top:14px">Scans</h3>
    <div id="scanList" class="list"></div>
  </div>
</div>

<script>
  const companyId = localStorage.getItem("companyId");
  const companyName = localStorage.getItem("companyName");

if (!companyId) {
  alert("Session expired. Please login again.");
  window.location.href = "client-login.html";
}

  var firebaseConfig = {
    apiKey: "AIzaSyBh-KhkmZrS6b97MPv-YTMjU6qTF0qFzbY",
    authDomain: "pakisa-floor.firebaseapp.com",
    databaseURL: "https://pakisa-floor-default-rtdb.firebaseio.com",
    projectId: "pakisa-floor",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let allScans = [];

  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

  function render(list){
    const container = document.getElementById('scanList');
    container.innerHTML = '';
    if(!list.length) { container.innerHTML='<i>No scans found</i>'; return; }
    list.forEach(d=>{
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `<strong>${escapeHtml(d.waybill)}</strong>
        <div style="font-size:13px;margin-top:6px">
          ${escapeHtml(d.customer)} — ${escapeHtml(d.reason)}
          <span style="float:right;color:#6b7280">${new Date(d.timestamp).toLocaleTimeString()}</span>
        </div>`;
      container.appendChild(el);
    });
  }

  function todayKey(){ return new Date().toISOString().slice(0,10); }

  function applyFilters(){
    const search = document.getElementById('searchFilter').value.trim().toLowerCase();
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    const filtered = allScans.filter(d=>{
      if(start && d.date < start) return false;
      if(end && d.date > end) return false;
      if(search && !((d.waybill||'').toLowerCase().includes(search) || (d.reason||'').toLowerCase().includes(search))) return false;
      return true;
    });
    render(filtered);
  }

  function loadScans(){
  db.ref("scans").push({
  companyId: companyId,        // ✅ REQUIRED
  customer: companyName,       // optional but useful
  waybill: waybill,
  reason: reason,
  date: todayKey(),
  timestamp: Date.now()
});

      const data = snapshot.val() || {};
      allScans = Object.values(data)
        .sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));

      const today = todayKey();
      const todayScans = allScans.filter(d => d.date === today);
      render(todayScans);

    })
    .catch(err => console.error("Error loading scans:", err));
}

  function exportExcel(){
    const filtered = getCurrentDisplay();
    const ws = XLSX.utils.json_to_sheet(filtered);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Scans");
    XLSX.writeFile(wb, "floor_scans.xlsx");
  }

  function exportPDF(){
    const filtered = getCurrentDisplay();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;
    filtered.forEach((d,i)=>{
      doc.text(`${i+1}. ${d.waybill} | ${d.customer} | ${d.reason} | ${new Date(d.timestamp).toLocaleString()}`, 10, y);
      y += 10;
      if(y>280){ doc.addPage(); y=10; }
    });
    doc.save("floor_scans.pdf");
  }

function getCurrentDisplay() {
  const search = document.getElementById('searchFilter').value.trim().toLowerCase();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;

  return allScans.filter(d => {
    if (start && d.date < start) return false;
    if (end && d.date > end) return false;
    if (
      search &&
      !(
        (d.waybill || "").toLowerCase().includes(search) ||
        (d.reason || "").toLowerCase().includes(search)
      )
    ) return false;

    return true;
  });
}

  window.onload = loadScans;
</script>

</body>
</html>
