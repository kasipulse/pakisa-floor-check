<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pakisa Floor Check</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="icon" href="pakisa_logistics_express_pty_ltd_logo-removebg-preview.png" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f4f7;
      margin: 0;
      padding: 0;
    }
    header {
      background: #fff;
      color: #0a2b52;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 3px solid #cebd80;
    }
    header img {
      height: 45px;
    }
    main {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 25px;
    }
    h1 {
      color: #0a2b52;
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
    }
    select, input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #cebd80;
      color: #000;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    button {
      background: #0a2b52;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #409dbc;
    }
    footer {
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-top: 25px;
    }
    footer a {
      color: #0a2b52;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <img src="pakisa_logistics_express_pty_ltd_logo-removebg-preview.png" alt="Pakisa Logo">
    <h2>Pakisa Logistics Express (Pty) Ltd</h2>
  </header>

  <main>
    <h1>Daily Floor Check</h1>

    <select id="customer">
      <option value="">Select customer</option>
      <option>FedEx Express</option>
      <option>Seabourne Logistics</option>
      <option>Brima Logistics</option>
      <option>AJM Couriers</option>
      <option>ACT</option>
      <option>First Freight Couriers</option>
    </select>

    <select id="reason">
      <option value="">Select reason</option>
      <option>Planned for next day</option>
      <option>Incorrect address</option>
      <option>No invoice on package</option>
      <option>Damaged in transit</option>
      <option>Rejected by customer</option>
      <option>Misroute</option>
      <option>No contact person</option>
      <option>Nobody home</option>
      <option>Missed booking</option>
    </select>

    <input id="waybill" placeholder="Scan or type waybill number and press Enter" autofocus>

    <table id="report">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Customer</th>
          <th>Reason</th>
          <th>Waybill</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="export">Export to PDF</button>
  </main>

  <footer>
    <p><a href="https://pakisa-floor-check.onrender.com" target="_blank">pakisa-floor-check.onrender.com</a></p>
    <p>Designed by Mpho Mahlaba © 2025</p>
  </footer>

  <script>
    // --- SUPABASE SETUP ---
    const SUPABASE_URL = "https://YOUR_SUPABASE_URL.supabase.co";
    const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const customerSelect = document.getElementById("customer");
    const reasonSelect = document.getElementById("reason");
    const waybillInput = document.getElementById("waybill");
    const tbody = document.querySelector("#report tbody");

    // --- DAILY RESET (auto-clear old data) ---
    async function resetOldData() {
      const today = new Date().toISOString().split("T")[0];
      await supabase.from("floor_scans").delete().lt("created_date", today);
    }

    // --- FETCH TODAY’S SCANS ---
    async function fetchScans() {
      const today = new Date().toISOString().split("T")[0];
      const { data, error } = await supabase
        .from("floor_scans")
        .select("*")
        .eq("created_date", today)
        .order("timestamp", { ascending: false });

      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(row.timestamp).toLocaleString()}</td>
          <td>${row.customer}</td>
          <td>${row.reason}</td>
          <td>${row.waybill}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- HANDLE SCAN ENTRY ---
    waybillInput.addEventListener("keypress", async e => {
      if (e.key === "Enter") {
        const customer = customerSelect.value;
        const reason = reasonSelect.value;
        const waybill = waybillInput.value.trim();

        if (!customer || !reason || !waybill) {
          alert("Please select customer, reason, and enter waybill.");
          return;
        }

        await supabase.from("floor_scans").insert([
          { customer, reason, waybill }
        ]);

        waybillInput.value = "";
        fetchScans();
      }
    });

    // --- EXPORT TO PDF ---
    document.getElementById("export").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const logo = new Image();
      logo.src = "pakisa_logistics_express_pty_ltd_logo-removebg-preview.png";

      doc.addImage(logo, "PNG", 10, 10, 30, 20);
      doc.setFontSize(14);
      doc.text("Pakisa Logistics Express (Pty) Ltd - Floor Check Report", 50, 20);
      doc.setFontSize(10);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 50, 27);

      let y = 40;
      doc.setFontSize(9);
      doc.setTextColor(0, 0, 0);
      doc.text("Time", 10, y);
      doc.text("Customer", 55, y);
      doc.text("Reason", 110, y);
      doc.text("Waybill", 165, y);

      y += 5;
      for (const row of tbody.rows) {
        const cells = row.cells;
        doc.text(cells[0].innerText, 10, y);
        doc.text(cells[1].innerText, 55, y);
        doc.text(cells[2].innerText, 110, y);
        doc.text(cells[3].innerText, 165, y);
        y += 5;
        if (y > 270) { doc.addPage(); y = 20; }
      }

      doc.setFontSize(9);
      doc.textWithLink("pakisa-floor-check.onrender.com", 10, 285, { url: "https://pakisa-floor-check.onrender.com" });
      doc.text("Designed by Mpho Mahlaba © 2025", 130, 285);
      doc.save(`Pakisa_FloorCheck_${new Date().toISOString().split('T')[0]}.pdf`);
    });

    // --- INITIAL LOAD ---
    (async () => {
      await resetOldData();
      await fetchScans();

      // Real-time updates
      supabase.channel("floor_scan_changes")
        .on("postgres_changes", { event: "*", schema: "public", table: "floor_scans" }, fetchScans)
        .subscribe();
    })();
  </script>
</body>
</html>
