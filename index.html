<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Floor Checks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">

  <h1 class="text-3xl font-bold mb-4">Daily Floor Checks</h1>

  <!-- Controls -->
  <div class="flex gap-2 mb-4">
    <select id="customerSelect" class="p-2 border rounded w-1/4">
      <option value="">Select customer</option>
      <option>Fedex Express</option>
      <option>Seabourne Logistics</option>
      <option>Brima Logistics</option>
      <option>AJM Couriers</option>
      <option>Act</option>
    </select>

    <select id="reasonSelect" class="p-2 border rounded w-1/4">
      <option value="">Select reason</option>
      <option>Planned for next day</option>
      <option>Incorrect address</option>
      <option>No invoice on package</option>
      <option>Damaged in transit</option>
      <option>Rejected by customer</option>
      <option>Misroute</option>
      <option>No contact person</option>
      <option>Nobody home</option>
      <option>Missed booking</option>
    </select>

    <input type="text" id="waybillInput" placeholder="Scan or type waybill â†’ Enter" class="p-2 border rounded w-1/2" autofocus>
  </div>

  <!-- Filters for report -->
  <div class="flex gap-2 mb-4">
    <select id="filterCustomer" class="p-2 border rounded w-1/4">
      <option value="">Filter by customer</option>
      <option>Fedex Express</option>
      <option>Seabourne Logistics</option>
      <option>Brima Logistics</option>
      <option>AJM Couriers</option>
      <option>Act</option>
    </select>

    <select id="filterReason" class="p-2 border rounded w-1/4">
      <option value="">Filter by reason</option>
      <option>Planned for next day</option>
      <option>Incorrect address</option>
      <option>No invoice on package</option>
      <option>Damaged in transit</option>
      <option>Rejected by customer</option>
      <option>Misroute</option>
      <option>No contact person</option>
      <option>Nobody home</option>
      <option>Missed booking</option>
    </select>

    <button id="exportCsv" class="p-2 bg-yellow-500 rounded">Export CSV</button>
    <button id="exportPdf" class="p-2 bg-blue-500 text-white rounded">Export PDF</button>
  </div>

  <!-- Table -->
  <table class="min-w-full bg-white rounded shadow overflow-hidden">
    <thead class="bg-gray-200">
      <tr>
        <th class="py-2 px-4">Customer</th>
        <th class="py-2 px-4">Waybill</th>
        <th class="py-2 px-4">Reason</th>
        <th class="py-2 px-4">Date & Time</th>
      </tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>

  <!-- Totals -->
  <div class="mt-4" id="totals"></div>

  <!-- Audio feedback -->
  <audio id="successAudio">
    <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
  </audio>
  <audio id="errorAudio">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  </audio>

  <script>
    let logs = [];

    const waybillInput = document.getElementById('waybillInput');
    const reasonSelect = document.getElementById('reasonSelect');
    const customerSelect = document.getElementById('customerSelect');
    const logBody = document.getElementById('logBody');
    const totalsDiv = document.getElementById('totals');
    const filterCustomer = document.getElementById('filterCustomer');
    const filterReason = document.getElementById('filterReason');
    const successAudio = document.getElementById('successAudio');
    const errorAudio = document.getElementById('errorAudio');

    // --- Helper functions ---
    function renderLogs() {
      const customerFilter = filterCustomer.value;
      const reasonFilter = filterReason.value;

      logBody.innerHTML = '';
      logs.forEach(entry => {
        if((!customerFilter || entry.customer === customerFilter) &&
           (!reasonFilter || entry.reason === reasonFilter)) {

          const tr = document.createElement('tr');
          tr.classList.add('border-b');
          tr.innerHTML = `
            <td class="py-2 px-4">${entry.customer}</td>
            <td class="py-2 px-4">${entry.waybill}</td>
            <td class="py-2 px-4">${entry.reason}</td>
            <td class="py-2 px-4">${entry.datetime}</td>
          `;
          tr.style.backgroundColor = entry.success ? '#d4edda' : '#f8d7da';
          logBody.appendChild(tr);
        }
      });

      // Totals
      const totalByReason = {};
      logs.forEach(l => {
        if(!totalByReason[l.reason]) totalByReason[l.reason] = 0;
        totalByReason[l.reason]++;
      });
      totalsDiv.innerHTML = '<h2 class="font-bold">Totals:</h2>' +
        Object.entries(totalByReason).map(([reason, count]) => `<div>${reason}: ${count}</div>`).join('');
    }

    function exportCSV() {
      const csv = ['Customer,Waybill,Reason,Date & Time']
        .concat(logs.map(l => `${l.customer},${l.waybill},${l.reason},${l.datetime}`))
        .join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `floor_checks_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const body = logs.map(l => [l.customer, l.waybill, l.reason, l.datetime]);
      doc.autoTable({ head:[['Customer','Waybill','Reason','Date & Time']], body });
      doc.save(`floor_checks_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // --- Event Listeners ---
    waybillInput.addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        const waybill = waybillInput.value.trim();
        const reason = reasonSelect.value;
        const customer = customerSelect.value;
        if(!waybill || !reason || !customer){
          errorAudio.play();
          alert('Select customer, reason and enter waybill');
          return;
        }

        const entry = {
          customer,
          waybill,
          reason,
          datetime: new Date().toLocaleString(),
          success: true
        };
        logs.unshift(entry);
        successAudio.play();
        renderLogs();
        waybillInput.value = '';
        waybillInput.focus();
      }
    });

    filterCustomer.addEventListener('change', renderLogs);
    filterReason.addEventListener('change', renderLogs);
    document.getElementById('exportCsv').addEventListener('click', exportCSV);
    document.getElementById('exportPdf').addEventListener('click', exportPDF);

    // Auto-reset at midnight
    setInterval(() => {
      const now = new Date();
      if(now.getHours() === 0 && now.getMinutes() === 0){
        logs = [];
        renderLogs();
      }
    }, 60000);

  </script>
</body>
</html>
