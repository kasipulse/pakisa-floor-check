<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Floor Checks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Daily Floor Checks</h1>

    <!-- Customer & Reason -->
    <div class="mb-4 flex flex-wrap gap-4 items-center">
      <div>
        <label class="block font-semibold">Customer</label>
        <select id="customer-select" class="border rounded p-2">
          <option value="Fedex Express">Fedex Express</option>
          <option value="Seabourne Logistics">Seabourne Logistics</option>
          <option value="Brima Logistics">Brima Logistics</option>
          <option value="AJM Couriers">AJM Couriers</option>
          <option value="ACT">ACT</option>
        </select>
      </div>

      <div>
        <label class="block font-semibold">Reason</label>
        <select id="reason-select" class="border rounded p-2">
          <option value="Planned for next day">Planned for next day</option>
          <option value="Incorrect address">Incorrect address</option>
          <option value="No invoice on package">No invoice on package</option>
          <option value="Damaged in transit">Damaged in transit</option>
          <option value="Rejected by customer">Rejected by customer</option>
          <option value="Misroute">Misroute</option>
          <option value="No contact person">No contact person</option>
          <option value="Nobody home">Nobody home</option>
          <option value="Missed booking">Missed booking</option>
        </select>
      </div>

      <div class="flex-1">
        <label class="block font-semibold">Scan Waybill</label>
        <input type="text" id="scan-input" class="border rounded p-2 w-full" placeholder="Scan or type waybill number">
      </div>

      <div class="flex gap-2 mt-4 md:mt-0">
        <button id="export-csv" class="bg-blue-500 text-white px-4 py-2 rounded">Export CSV</button>
        <button id="export-pdf" class="bg-green-500 text-white px-4 py-2 rounded">Export PDF</button>
      </div>
    </div>

    <!-- Table Container -->
    <div id="table-container" class="transition-all duration-300">
      <table class="min-w-full bg-white rounded shadow overflow-hidden">
        <thead class="bg-[#DEB657] text-white">
          <tr>
            <th class="py-2 px-4 text-left">Time</th>
            <th class="py-2 px-4 text-left">Customer</th>
            <th class="py-2 px-4 text-left">Reason</th>
            <th class="py-2 px-4 text-left">Waybill</th>
          </tr>
        </thead>
        <tbody id="floor-checks-body"></tbody>
      </table>
    </div>

    <p class="text-sm mt-4 text-gray-500">Designed by Mpho Mahlaba</p>
  </div>

  <script>
    const floorChecks = [];
    const scanInput = document.getElementById('scan-input');
    const customerSelect = document.getElementById('customer-select');
    const reasonSelect = document.getElementById('reason-select');
    const tbody = document.getElementById('floor-checks-body');
    const tableContainer = document.getElementById('table-container');

    const beepSuccess = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
    const beepError = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

    function addRow({time, customer, reason, waybill}) {
      const tr = document.createElement('tr');
      tr.classList.add('border-b');
      tr.innerHTML = `
        <td class="py-2 px-4">${time}</td>
        <td class="py-2 px-4">${customer}</td>
        <td class="py-2 px-4">${reason}</td>
        <td class="py-2 px-4">${waybill}</td>
      `;
      tbody.prepend(tr);
    }

    function flashGreen() {
      tableContainer.style.backgroundColor = '#d1fae5';
      setTimeout(() => tableContainer.style.backgroundColor = '', 300);
    }

    function handleScan(waybill) {
      if (!waybill.trim()) {
        beepError.play();
        return;
      }
      const now = new Date().toLocaleTimeString();
      const customer = customerSelect.value;
      const reason = reasonSelect.value;
      floorChecks.push({time: now, customer, reason, waybill});
      addRow({time: now, customer, reason, waybill});
      beepSuccess.play();
      flashGreen();
      scanInput.value = '';
    }

    scanInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') handleScan(scanInput.value);
    });

    // Auto-reset at midnight
    function resetIfNewDay() {
      const today = new Date().toDateString();
      if (!localStorage.getItem('lastDate') || localStorage.getItem('lastDate') !== today) {
        floorChecks.length = 0;
        tbody.innerHTML = '';
        localStorage.setItem('lastDate', today);
      }
    }
    setInterval(resetIfNewDay, 60000);
    resetIfNewDay();

    // Export CSV
    document.getElementById('export-csv').addEventListener('click', () => {
      if (!floorChecks.length) return alert('No scans yet');
      const headers = ['Time', 'Customer', 'Reason', 'Waybill'];
      const csv = [
        headers.join(','),
        ...floorChecks.map(r => [r.time,r.customer,r.reason,r.waybill].join(','))
      ].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `floor_checks_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Export PDF (branded)
    document.getElementById('export-pdf').addEventListener('click', () => {
      if (!floorChecks.length) return alert('No scans yet');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const headerColor = '#072760';
      const headerHeight = 20;
      const tableHeaderColor = '#DEB657';
      const lineHeight = 8;

      let yOffset = headerHeight + 10;

      // Draw header bar
      doc.setFillColor(headerColor);
      doc.rect(0, 0, pageWidth, headerHeight, 'F');
      doc.setTextColor('#ffffff');
      doc.setFontSize(14);
      doc.text('DAILY FLOOR CHECK REPORT', pageWidth / 2, 14, { align: 'center' });
      doc.setFontSize(10);
      doc.text(`Date: ${new Date().toLocaleString()}`, pageWidth - 10, 14, { align: 'right' });

      // Table header
      doc.setFillColor(tableHeaderColor);
      doc.setTextColor('#ffffff');
      doc.setFontSize(10);
      doc.rect(10, yOffset - 6, pageWidth - 20, 8, 'F');
      doc.text('Time | Customer | Reason | Waybill', 12, yOffset);
      yOffset += lineHeight;

      // Table content
      floorChecks.forEach((r, i) => {
        if (yOffset > pageHeight - 20) {
          // Footer
          doc.setFontSize(8);
          doc.setTextColor('#072760');
          doc.text('Application built by Mpho Mahlaba', 10, pageHeight - 10);
          doc.text('Copyright 2025 | https://pakisa-floor-check.onrender.com', pageWidth - 10, pageHeight - 10, { align: 'right' });
          doc.addPage();

          // Repeat header
          doc.setFillColor(headerColor);
          doc.setTextColor('#ffffff');
          doc.rect(0, 0, pageWidth, headerHeight, 'F');
          doc.setFontSize(14);
          doc.text('DAILY FLOOR CHECK REPORT', pageWidth / 2, 14, { align: 'center' });
          doc.setFontSize(10);
          doc.text(`Date: ${new Date().toLocaleString()}`, pageWidth - 10, 14, { align: 'right' });

          yOffset = headerHeight + 10;
          // Table header
          doc.setFillColor(tableHeaderColor);
          doc.setTextColor('#ffffff');
          doc.setFontSize(10);
          doc.rect(10, yOffset - 6, pageWidth - 20, 8, 'F');
          doc.text('Time | Customer | Reason | Waybill', 12, yOffset);
          yOffset += lineHeight;
        }

        // Alternate row color
        if (i % 2 === 0) {
          doc.setFillColor('#e0f2ff'); // light blue
          doc.rect(10, yOffset - 6, pageWidth - 20, lineHeight, 'F');
        }

        doc.setTextColor('#000000');
        doc.text(`${r.time} | ${r.customer} | ${r.reason} | ${r.waybill}`, 12, yOffset);
        yOffset += lineHeight;
      });

      // Footer on last page
      doc.setFontSize(8);
      doc.setTextColor('#072760');
      doc.text('Application built by Mpho Mahlaba', 10, pageHeight - 10);
      doc.text('Copyright 2025 | https://pakisa-floor-check.onrender.com', pageWidth - 10, pageHeight - 10, { align: 'right' });

      doc.save(`floor_checks_${new Date().toISOString().slice(0,10)}.pdf`);
    });

    // Smart focus
    function keepFocus() {
      const active = document.activeElement;
      const ignored = ['SELECT', 'BUTTON'];
      if (!ignored.includes(active.tagName)) scanInput.focus();
    }
    setInterval(keepFocus, 800);
  </script>
</body>
</html>
