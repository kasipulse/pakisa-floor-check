<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pakisa Floor Scan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        padding: 20px;
    }

    h2 {
        margin-top: 0;
    }

    .box {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
        margin-bottom: 20px;
    }

    #barcodeInput {
        width: 100%;
        padding: 15px;
        font-size: 20px;
        border: 2px solid #333;
    }

    #barcodeInput.scanned {
        border-color: green;
        background: #e9ffe9;
    }

    ul {
        background: white;
        padding: 10px;
        border-radius: 6px;
        list-style: none;
    }

    li {
        padding: 6px 0;
        border-bottom: 1px solid #ddd;
    }

    footer {
        text-align: center;
        margin-top: 20px;
        font-size: 13px;
        color: #555;
    }
</style>

</head>
<body>

<h2>ðŸ“¦ Pakisa Floor Check</h2>

<div class="box">
    <label><b>Select Date:</b></label>
    <input type="date" id="dateFilter" style="padding:10px; font-size:16px;">
</div>

<div class="box">
    <label><b>Scan Waybill:</b></label>
    <input type="text" id="barcodeInput" placeholder="Scan barcode..." autofocus autocomplete="off">
</div>

<div class="box">
    <h3>Todayâ€™s Scans</h3>
    <ul id="scanList"></ul>
</div>

<footer>
    Designed by <b>Mpho Mahlaba</b>
</footer>

<!-- Beep sound -->
<audio id="beepSound">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
</audio>

<!-- FIREBASE -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getDatabase, ref, push, set, get, query, orderByChild, equalTo 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ðŸ”¥ Your Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBh-KhkmZrS6b97MPv-YTMjU6qTF0qFzbY",
        authDomain: "pakisa-floor.firebaseapp.com",
        databaseURL: "https://pakisa-floor-default-rtdb.firebaseio.com/",
        projectId: "pakisa-floor",
        storageBucket: "pakisa-floor.appspot.com",
        messagingSenderId: "1003516506618",
        appId: "1:1003516506618:web:777d702f93616b6e323443",
        measurementId: "G-JBZ8DYW49B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const barcodeInput = document.getElementById("barcodeInput");
    const scanList = document.getElementById("scanList");
    const dateFilter = document.getElementById("dateFilter");
    const beep = document.getElementById("beepSound");

    // ---------------------------------------------------
    // ðŸ”¥ GET TODAY DATE
    // ---------------------------------------------------
    function todayDate() {
        return new Date().toISOString().substring(0, 10);
    }

    // ---------------------------------------------------
    // ðŸ”¥ SAVE SCAN
    // ---------------------------------------------------
    async function saveScan(barcode) {
        const scanRef = push(ref(db, "floor_scans"));

        const data = {
            barcode: barcode,
            timestamp: Date.now(),
            date: todayDate()
        };

        await set(scanRef, data);
    }

    // ---------------------------------------------------
    // ðŸ”¥ LOAD SCANS FOR A SPECIFIC DATE
    // ---------------------------------------------------
    async function loadScansByDate(date) {
        const q = query(ref(db, "floor_scans"), orderByChild("date"), equalTo(date));
        const snapshot = await get(q);

        const results = [];
        if (snapshot.exists()) {
            snapshot.forEach(child => results.push(child.val()));
        }

        displayScans(results);
    }

    // ---------------------------------------------------
    // ðŸ”¥ DISPLAY SCANS
    // ---------------------------------------------------
    function displayScans(list) {
        scanList.innerHTML = "";
        list.forEach(item => {
            const li = document.createElement("li");
            li.textContent = `${item.barcode} â€” ${new Date(item.timestamp).toLocaleTimeString()}`;
            scanList.appendChild(li);
        });
    }

    // ---------------------------------------------------
    // ðŸ”¥ SCAN HANDLER
    // ---------------------------------------------------
    barcodeInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter" && barcodeInput.value.trim() !== "") {

            const code = barcodeInput.value.trim();

            beep.play();

            barcodeInput.classList.add("scanned");

            await saveScan(code);

            barcodeInput.value = "";
            setTimeout(() => barcodeInput.classList.remove("scanned"), 300);

            // Load today's scans again
            loadScansByDate(todayDate());
        }
    });

    // ---------------------------------------------------
    // ðŸ”¥ DATE FILTER LISTENER
    // ---------------------------------------------------
    dateFilter.addEventListener("change", () => {
        if (dateFilter.value) {
            loadScansByDate(dateFilter.value);
        }
    });

    // ---------------------------------------------------
    // ðŸ”¥ ON PAGE LOAD â€” SHOW BLANK SCREEN
    // ---------------------------------------------------
    displayScans([]);
</script>

</body>
</html>
