<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Floor Checks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Daily Floor Checks</h1>

    <!-- Customer & Reason -->
    <div class="mb-4 flex flex-wrap gap-4 items-center">
      <div>
        <label class="block font-semibold">Customer</label>
        <select id="customer-select" class="border rounded p-2">
          <option value="Fedex Express">Fedex Express</option>
          <option value="Seabourne Logistics">Seabourne Logistics</option>
          <option value="Brima Logistics">Brima Logistics</option>
          <option value="AJM Couriers">AJM Couriers</option>
          <option value="ACT">ACT</option>
        </select>
      </div>

      <div>
        <label class="block font-semibold">Reason</label>
        <select id="reason-select" class="border rounded p-2">
          <option value="Planned for next day">Planned for next day</option>
          <option value="Incorrect address">Incorrect address</option>
          <option value="No invoice on package">No invoice on package</option>
          <option value="Damaged in transit">Damaged in transit</option>
          <option value="Rejected by customer">Rejected by customer</option>
          <option value="Misroute">Misroute</option>
          <option value="No contact person">No contact person</option>
          <option value="Nobody home">Nobody home</option>
          <option value="Missed booking">Missed booking</option>
        </select>
      </div>

      <div class="flex-1">
        <label class="block font-semibold">Scan Waybill</label>
        <input type="text" id="scan-input" class="border rounded p-2 w-full" placeholder="Scan or type waybill number">
      </div>

      <div class="flex gap-2 mt-4 md:mt-0">
        <button id="export-csv" class="bg-blue-500 text-white px-4 py-2 rounded">Export CSV</button>
        <button id="export-pdf" class="bg-green-500 text-white px-4 py-2 rounded">Export PDF</button>
      </div>
    </div>

    <!-- Table -->
    <table class="min-w-full bg-white rounded shadow overflow-hidden">
      <thead class="bg-gray-200">
        <tr>
          <th class="py-2 px-4 text-left">Time</th>
          <th class="py-2 px-4 text-left">Customer</th>
          <th class="py-2 px-4 text-left">Reason</th>
          <th class="py-2 px-4 text-left">Waybill</th>
          <th class="py-2 px-4 text-left">Status</th>
        </tr>
      </thead>
      <tbody id="floor-checks-body"></tbody>
    </table>

    <p class="text-sm mt-4 text-gray-500">Designed by Mpho Mahlaba</p>
  </div>

  <script>
    const floorChecks = [];
    const scanInput = document.getElementById('scan-input');
    const customerSelect = document.getElementById('customer-select');
    const reasonSelect = document.getElementById('reason-select');
    const tbody = document.getElementById('floor-checks-body');

    // Success/error beep
    const beepSuccess = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
    const beepError = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

    function addRow({time, customer, reason, waybill, status}) {
      const tr = document.createElement('tr');
      tr.classList.add('border-b');
      tr.innerHTML = `
        <td class="py-2 px-4">${time}</td>
        <td class="py-2 px-4">${customer}</td>
        <td class="py-2 px-4">${reason}</td>
        <td class="py-2 px-4">${waybill}</td>
        <td class="py-2 px-4">${status}</td>
      `;
      tr.style.backgroundColor = status === 'Success' ? '#d1fae5' : '#fee2e2';
      tbody.prepend(tr);
    }

    function handleScan(waybill) {
      if (!waybill.trim()) return beepError.play();
      const now = new Date().toLocaleTimeString();
      const customer = customerSelect.value;
      const reason = reasonSelect.value;
      const status = 'Success';

      floorChecks.push({time: now, customer, reason, waybill, status});
      addRow({time: now, customer, reason, waybill, status});
      beepSuccess.play();
      scanInput.value = '';
    }

    scanInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        handleScan(scanInput.value);
      }
    });

    // Auto-reset at midnight
    function resetIfNewDay() {
      const today = new Date().toDateString();
      if (!localStorage.getItem('lastDate') || localStorage.getItem('lastDate') !== today) {
        floorChecks.length = 0;
        tbody.innerHTML = '';
        localStorage.setItem('lastDate', today);
      }
    }
    setInterval(resetIfNewDay, 60000);
    resetIfNewDay();

    // Export CSV
    document.getElementById('export-csv').addEventListener('click', () => {
      if (!floorChecks.length) return alert('No scans yet');
      const headers = ['Time', 'Customer', 'Reason', 'Waybill', 'Status'];
      const csv = [
        headers.join(','),
        ...floorChecks.map(r => [r.time,r.customer,r.reason,r.waybill,r.status].join(','))
      ].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `floor_checks_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Export PDF
    document.getElementById('export-pdf').addEventListener('click', () => {
      if (!floorChecks.length) return alert('No scans yet');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Daily Floor Checks", 14, 20);
      doc.setFontSize(10);

      floorChecks.forEach((r, i) => {
        const y = 30 + i * 8;
        doc.text(`${r.time} | ${r.customer} | ${r.reason} | ${r.waybill} | ${r.status}`, 14, y);
      });

      doc.setFontSize(8);
      doc.text("Designed by Mpho Mahlaba", 14, 290);
      doc.save(`floor_checks_${new Date().toISOString().slice(0,10)}.pdf`);
    });

    // Focus ready for next scan
    scanInput.focus();
    setInterval(() => scanInput.focus(), 500);
  </script>
</body>
</html>
