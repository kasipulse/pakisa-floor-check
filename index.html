<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pakisa Floor Check</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f2f4f7;
      margin: 0;
      padding: 0;
    }
    header {
      background: #fff;
      color: #0a2b52;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 3px solid #cebd80;
    }
    header img {
      height: 45px;
    }
    main {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 25px;
    }
    h1 {
      color: #0a2b52;
      font-size: 22px;
      text-align: center;
      margin-bottom: 20px;
    }
    select, input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #cebd80;
      color: #000;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    button {
      background: #0a2b52;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #409dbc;
    }
    footer {
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-top: 25px;
    }
    footer a {
      color: #0a2b52;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <img src="pakisa_logistics_express_pty_ltd_logo-removebg-preview.png" alt="Pakisa Logo">
    <h2>Pakisa Logistics Express (Pty) Ltd</h2>
  </header>

  <main>
    <h1>Daily Floor Check</h1>

    <select id="customer">
      <option value="">Select customer</option>
      <option>FedEx Express</option>
      <option>Seabourne Logistics</option>
      <option>Brima Logistics</option>
      <option>AJM Couriers</option>
      <option>ACT</option>
      <option>First Freight Couriers</option>
    </select>

    <select id="reason">
      <option value="">Select reason</option>
      <option>Planned for next day</option>
      <option>Incorrect address</option>
      <option>No invoice on package</option>
      <option>Damaged in transit</option>
      <option>Rejected by customer</option>
      <option>Misroute</option>
      <option>No contact person</option>
      <option>Nobody home</option>
      <option>Missed booking</option>
    </select>

    <input id="waybill" placeholder="Scan or type waybill number and press Enter" autofocus>

    <table id="report">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Customer</th>
          <th>Reason</th>
          <th>Waybill</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="export">Export to PDF</button>
  </main>

  <footer>
    <p><a href="https://pakisa-floor-check.onrender.com" target="_blank">pakisa-floor-check.onrender.com</a></p>
    <p>Designed by Mpho Mahlaba Â© 2025</p>
  </footer>

  <script>
    const SUPABASE_URL = "https://orhqnjxigboyvnwaopxu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yaHFuanhpZ2JveXZud2FvcHh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0OTI3MTksImV4cCI6MjA3NjA2ODcxOX0.KAk9QL0T7VwzXdbH1-Rei0P9x0XHeEI4jcDuPHxK28M";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const waybillInput = document.getElementById("waybill");
    const customerSelect = document.getElementById("customer");
    const reasonSelect = document.getElementById("reason");
    const tbody = document.querySelector("#report tbody");

    // Load beep sound
    const beep = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

    // Daily reset
    async function resetOldData() {
      const today = new Date().toISOString().split("T")[0];
      await supabase.from("floor_scans").delete().lt("created_date", today);
    }

    // Fetch today's scans
    async function fetchScans() {
      const today = new Date().toISOString().split("T")[0];
      const { data } = await supabase
        .from("floor_scans")
        .select("*")
        .eq("created_date", today)
        .order("timestamp", { ascending: false });

      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(row.timestamp).toLocaleTimeString()}</td>
          <td>${row.customer}</td>
          <td>${row.reason}</td>
          <td>${row.waybill}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Handle scan
    waybillInput.addEventListener("keypress", async e => {
      if (e.key === "Enter") {
        const waybill = waybillInput.value.trim();
        const customer = customerSelect.value;
        const reason = reasonSelect.value;
        if (!customer || !reason || !waybill) {
          alert("Select customer, reason and scan waybill first.");
          return;
        }

        await supabase.from("floor_scans").insert([{ customer, reason, waybill }]);
        beep.play();
        waybillInput.value = "";
        await fetchScans();
      }
    });

    // Keep input focused unless interacting with dropdowns
    setInterval(() => {
      const active = document.activeElement.tagName;
      if (active !== "SELECT" && active !== "BUTTON") {
        waybillInput.focus();
      }
    }, 600);

    // Initialize
    (async () => {
      await resetOldData();
      await fetchScans();
      supabase.channel("floor_scan_changes")
        .on("postgres_changes", { event: "*", schema: "public", table: "floor_scans" }, fetchScans)
        .subscribe();
    })();
  </script>
</body>
</html>
