<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pakisa Floor Check â€” Daily</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/supabase.min.js"></script>

  <style>
    body { background: #f3f5f7; min-height:100vh; }
    .brand-navy { color: #0a2b52; }
    .brand-navy-bg { background: #0a2b52; }
    .brand-blue { background: #409dbc; }
    .brand-gold { background: #cebd80; }
  </style>
</head>
<body class="font-sans antialiased">

  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center gap-4 mb-6">
      <img id="logo" src="LOGO_URL" alt="Pakisa Logo" class="w-36 h-auto rounded-sm shadow-sm"/>
      <div>
        <h1 class="text-2xl font-bold brand-navy">Pakisa Express Logistics</h1>
        <div class="text-sm text-gray-600">Daily Floor Check â€” <span class="font-semibold">Designed by Mpho Mahlaba â€” <span class="italic">The King</span> ðŸ‘‘</span></div>
      </div>
      <div class="ml-auto text-right text-xs text-gray-500">
        <div id="envNote">Offline Mode</div>
      </div>
    </header>

    <main class="bg-white rounded-lg shadow p-5">

      <!-- Controls -->
      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium">Client / Company</label>
          <select id="company" class="mt-1 block w-full border rounded p-2">
            <option>FedEx Express</option>
            <option>Seabourne Logistics</option>
            <option>Brima Logistics</option>
            <option>First Freight Couriers</option>
            <option>AJM Couriers</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium">Reason</label>
          <select id="reason" class="mt-1 block w-full border rounded p-2">
            <option>Planned for next day</option>
            <option>Incorrect address</option>
            <option>No invoice on package</option>
            <option>Damaged in transit</option>
            <option>Rejected by customer</option>
            <option>Misroute</option>
            <option>No contact person</option>
            <option>Nobody home</option>
            <option>Missed booking</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium">Scanned by (station/user)</label>
          <input id="scanned_by" class="mt-1 block w-full border rounded p-2" placeholder="e.g. Floor A - Lebo"/>
        </div>
      </div>

      <!-- Scan input -->
      <div class="flex gap-4 items-center mb-4">
        <div class="flex-grow">
          <label class="block text-sm font-medium">Scan Waybill</label>
          <input id="waybillInput" autocomplete="off" autofocus
                 class="mt-1 block w-full border rounded p-3 text-lg font-mono"
                 placeholder="Scan or type waybill here â€” ready for next scan automatically" />
          <div class="text-xs text-gray-500 mt-1">Scanners that append Enter will submit automatically. If not, the app auto-submits ~300ms after input stops.</div>
        </div>

        <div class="w-44">
          <label class="block text-sm font-medium invisible">Button</label>
          <button id="manualAdd" class="w-full brand-navy-bg text-white rounded p-3">Add (manual)</button>
        </div>
      </div>

      <!-- top row -->
      <div class="flex justify-between items-center mb-4">
        <div>
          <span class="text-gray-600">Today: </span><span id="todayLabel" class="font-medium"></span>
          <span class="ml-4 text-gray-500 text-sm" id="liveStatus">Live</span>
        </div>
        <div class="flex gap-2">
          <button id="exportCsv" class="px-3 py-2 border rounded">Export CSV</button>
          <button id="clearUI" class="px-3 py-2 border rounded">Clear Today (UI)</button>
        </div>
      </div>

      <!-- summary -->
      <div class="mb-4 grid md:grid-cols-3 gap-4">
        <div class="p-3 brand-gold rounded text-center">
          <div class="text-sm">Total Scanned Today</div>
          <div id="totalCount" class="text-2xl font-bold">0</div>
        </div>
        <div class="p-3 brand-blue rounded text-white">
          <div class="text-sm">Top Reason</div>
          <div id="topReason" class="text-lg font-semibold">â€”</div>
        </div>
        <div class="p-3 border rounded text-sm">
          <div><strong>Top Company:</strong> <span id="topCompany">â€”</span></div>
          <div class="mt-2 text-xs text-gray-600">Auto-ready scanning â€” no Enter required</div>
        </div>
      </div>

      <!-- live table -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="resultsTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs">Time</th>
              <th class="px-3 py-2 text-left text-xs">Company</th>
              <th class="px-3 py-2 text-left text-xs">Waybill</th>
              <th class="px-3 py-2 text-left text-xs">Reason</th>
              <th class="px-3 py-2 text-left text-xs">Scanned by</th>
              <th class="px-3 py-2 text-left text-xs">Remarks</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>

    </main>

    <footer class="mt-4 text-center text-xs text-gray-500">
      Pakisa Express Logistics â€¢ Floor Check App â€¢ Designed by Mpho Mahlaba â€” <strong>The King</strong> ðŸ‘‘
    </footer>
  </div>

  <!-- optional beep -->
  <audio id="beep" src=""></audio>

  <script>
    /* ===========================
       CONFIG - REPLACE THESE
       ===========================
       - SUPABASE_URL:  https://yourproject.supabase.co
       - SUPABASE_ANON_KEY: anon public key (or use secure auth)
       - LOGO_URL: public URL to your Pakisa logo
    */
    const SUPABASE_URL = 'https://SUPABASE_URL_PLACEHOLDER';
    const SUPABASE_ANON_KEY = 'SUPABASE_ANON_KEY_PLACEHOLDER';
    const LOGO_URL = 'LOGO_URL_PLACEHOLDER'; // replace with your hosted logo
    /* ================================================== */

    // inject logo
    document.getElementById('logo').src = LOGO_URL;

    // init supabase client
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ui refs
    const waybillInput = document.getElementById('waybillInput');
    const companyEl = document.getElementById('company');
    const reasonEl = document.getElementById('reason');
    const scannedByEl = document.getElementById('scanned_by');
    const tableBody = document.getElementById('tableBody');
    const totalCountEl = document.getElementById('totalCount');
    const topReasonEl = document.getElementById('topReason');
    const topCompanyEl = document.getElementById('topCompany');
    const todayLabel = document.getElementById('todayLabel');
    const envNote = document.getElementById('envNote');
    const liveStatus = document.getElementById('liveStatus');
    const beep = document.getElementById('beep');

    // app config
    const SCAN_DELAY_MS = 300; // milliseconds after last input to auto-submit
    const MIN_WAYBILL_LENGTH = 6; // tweak to your waybill length rules
    const today = new Date().toISOString().slice(0,10);
    todayLabel.textContent = today;

    // helper: escape html
    function escapeHtml(s){ if(!s) return ''; return s.toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // add a scan record to Supabase
    async function addScan(waybill) {
      if(!waybill || waybill.trim()==='') return false;
      const payload = {
        scan_date: today,
        time: new Date().toISOString(),
        company: companyEl.value,
        reason: reasonEl.value,
        waybill_number: waybill.trim(),
        scanned_by: scannedByEl.value || null
      };
      // insert
      const { data, error } = await supabase.from('floor_checks').insert(payload).select();
      if (error) {
        console.error('Insert error', error);
        alert('Error saving scan (check console).');
        return false;
      }
      // clear & focus for next
      waybillInput.value = '';
      waybillInput.focus();
      // optional beep
      try { if (beep.src) beep.play(); } catch(e){}
      return true;
    }

    // load today's rows
    async function loadToday() {
      const { data, error } = await supabase
        .from('floor_checks')
        .select('*')
        .eq('scan_date', today)
        .order('created_at', { ascending: true });
      if (error) { console.error(error); return; }
      renderRows(data || []);
      updateSummary(data || []);
    }

    // render rows into table
    function renderRows(rows) {
      tableBody.innerHTML = '';
      rows.forEach(r => {
        const time = r.time ? new Date(r.time).toLocaleTimeString() : (r.created_at ? new Date(r.created_at).toLocaleTimeString() : '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${escapeHtml(time)}</td>
          <td class="px-3 py-2 text-sm">${escapeHtml(r.company)}</td>
          <td class="px-3 py-2 text-sm font-mono">${escapeHtml(r.waybill_number)}</td>
          <td class="px-3 py-2 text-sm">${escapeHtml(r.reason)}</td>
          <td class="px-3 py-2 text-sm">${escapeHtml(r.scanned_by || '')}</td>
          <td class="px-3 py-2 text-sm">${escapeHtml(r.remarks || '')}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // summary compute
    function updateSummary(rows) {
      totalCountEl.textContent = (rows || []).length;
      const reasonCounts = {};
      const compCounts = {};
      (rows || []).forEach(r => { reasonCounts[r.reason] = (reasonCounts[r.reason]||0)+1; compCounts[r.company] = (compCounts[r.company]||0)+1; });
      const topReason = Object.entries(reasonCounts).sort((a,b)=>b[1]-a[1])[0];
      topReasonEl.textContent = topReason ? `${topReason[0]} (${topReason[1]})` : 'â€”';
      const topComp = Object.entries(compCounts).sort((a,b)=>b[1]-a[1])[0];
      topCompanyEl.textContent = topComp ? `${topComp[0]} (${topComp[1]})` : 'â€”';
    }

    // realtime subscription to inserts
    function subscribeRealtime() {
      try {
        supabase.channel('floor_checks_channel')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'floor_checks' }, payload => {
            const row = payload.new;
            if (row.scan_date === today) {
              // append and refresh summary
              loadToday();
              // small flash could be added
            }
          })
          .subscribe()
          .then(() => { liveStatus.textContent = 'Live'; });
      } catch (e) {
        console.warn('Realtime subscribe maybe not available', e);
        liveStatus.textContent = 'Live (polling)';
      }
    }

    // CSV export
    function downloadCSV(rows, filename) {
      if (!rows || rows.length === 0) return alert('No rows to export.');
      const keys = ['time','company','waybill_number','reason','scanned_by','remarks'];
      const csv = [
        keys.join(','),
        ...rows.map(r => keys.map(k => `"${(r[k] || '').toString().replace(/"/g,'""')}"`).join(','))
      ].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // UI hooks
    document.getElementById('exportCsv').addEventListener('click', async () => {
      const { data } = await supabase.from('floor_checks').select('*').eq('scan_date', today).order('created_at', { ascending: true });
      downloadCSV(data || [], `floorchecks-${today}.csv`);
    });
    document.getElementById('clearUI').addEventListener('click', () => {
      tableBody.innerHTML = ''; totalCountEl.textContent = '0'; topReasonEl.textContent = 'â€”'; topCompanyEl.textContent='â€”';
    });
    document.getElementById('manualAdd').addEventListener('click', async () => {
      const v = waybillInput.value.trim(); if (v) await addScan(v);
    });

    // Auto-submit logic (Enter or timer)
    let scanTimeout = null;
    waybillInput.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const v = waybillInput.value.trim();
        if (v.length >= MIN_WAYBILL_LENGTH) await addScan(v);
      }
    });
    waybillInput.addEventListener('input', (e) => {
      clearTimeout(scanTimeout);
      const v = e.target.value.trim();
      if (v.length >= MIN_WAYBILL_LENGTH) {
        scanTimeout = setTimeout(async () => { await addScan(v); }, SCAN_DELAY_MS);
      }
    });

    // initialisation
    (async function init(){
      // show whether config placeholders remain
      if (SUPABASE_URL.includes('PLACEHOLDER') || SUPABASE_ANON_KEY.includes('PLACEHOLDER')) {
        envNote.textContent = 'Supabase config not set (edit file)';
        envNote.classList.add('text-red-600');
      } else {
        envNote.textContent = 'Connected to Supabase';
        envNote.classList.add('text-green-600');
      }

      // load saved scanner name (per-device)
      const savedName = localStorage.getItem('pakisa_scanner_name') || '';
      if (!savedName) {
        const n = prompt('Enter your station or name (saved on this device):', 'Floor A - ');
        if (n) { scannedByEl.value = n; localStorage.setItem('pakisa_scanner_name', n); }
      } else scannedByEl.value = savedName;
      scannedByEl.addEventListener('change', () => localStorage.setItem('pakisa_scanner_name', scannedByEl.value));

      // load & subscribe
      await loadToday();
      subscribeRealtime();
      waybillInput.focus();
    })();

  </script>
</body>
</html>
