<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Floor Check</title>

<style>
  body {
    font-family: Arial;
    padding: 20px;
    background: white;
    transition: background-color 0.15s ease;
  }

  select, input, textarea, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    font-size: 16px;
  }

  textarea {
    resize: vertical;
  }

  button {
    background: #0a2b52;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  .list-item {
    padding: 10px;
    background: #f2f2f2;
    margin: 6px 0;
    border-radius: 8px;
  }

  .flash {
    background-color: #2ecc71 !important;
  }
</style>

<audio id="beep" preload="auto">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onValue
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  /* ðŸ”¥ FIREBASE CONFIG */
  const firebaseConfig = {
    apiKey: "AIzaSyBh-KhkmZrS6b97MPv-YTMjU6qTF0qFzbY",
    authDomain: "pakisa-floor.firebaseapp.com",
    projectId: "pakisa-floor",
    databaseURL: "https://pakisa-floor-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  /* ðŸ” ADMINS */
  const ADMINS = [
    "ops1@pakisalogistics.co.za",
    "ops2@pakisalogistics.co.za",
    "csd@pakisalogistics.co.za",
    "csd1@pakisalogistics.co.za"
  ];

  onAuthStateChanged(auth, user => {
    if (!user || !ADMINS.includes(user.email)) {
      window.location.href = "/index.html";
    }
  });

  /* DOM */
  let customer, reason, scanInput, bulkInput, scanList, searchInput, dateFilter, beep;
  let currentData = [];
  let scanLock = false;

  function todayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  window.addEventListener("DOMContentLoaded", () => {
    customer = document.getElementById("customer");
    reason = document.getElementById("reason");
    scanInput = document.getElementById("scanInput");
    bulkInput = document.getElementById("bulkInput");
    scanList = document.getElementById("scanList");
    searchInput = document.getElementById("searchInput");
    dateFilter = document.getElementById("dateFilter");
    beep = document.getElementById("beep");

    dateFilter.value = todayKey();
    loadScans();

    scanInput.focus();

    scanInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveScan();
      }
    });
  });

  /* LOAD ALL SCANS */
  function loadScans() {
    onValue(ref(db, "scans"), snap => {
      currentData = [];
      snap.forEach(c => currentData.push(c.val()));
      currentData.sort((a,b) => b.timestamp - a.timestamp);
      renderList(currentData);
    });
  }

  function renderList(arr) {
    const filterDate = dateFilter.value;
    scanList.innerHTML = "";

    const filtered = filterDate
      ? arr.filter(s => s.date === filterDate)
      : arr;

    if (!filtered.length) {
      scanList.innerHTML = "<i>No scans for this date</i>";
      return;
    }

    filtered.forEach(d => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `<b>${d.waybill}</b><br>${d.customer} â€” ${d.reason}`;
      scanList.appendChild(div);
    });
  }

  window.filterSearch = () => {
    const t = searchInput.value.toLowerCase();
    renderList(
      currentData.filter(d =>
        d.waybill.toLowerCase().includes(t) ||
        d.customer.toLowerCase().includes(t) ||
        d.reason.toLowerCase().includes(t)
      )
    );
  };

  window.changeDate = () => renderList(currentData);

  /* SINGLE SCAN */
  window.saveScan = () => {
    if (scanLock) return;
    scanLock = true;

    const waybill = scanInput.value.trim();
    if (!customer.value || !reason.value || !waybill) {
      scanLock = false;
      return;
    }

    const scanData = {
      customer: customer.value,
      reason: reason.value,
      waybill,
      date: todayKey(),
      timestamp: Date.now()
    };

    push(ref(db, "scans"), scanData).then(() => {
      currentData.push(scanData);
      renderList(currentData);

      beep.play();
      document.body.classList.add("flash");
      setTimeout(() => document.body.classList.remove("flash"), 150);

      scanInput.value = "";
      scanInput.focus();
      scanLock = false;
    });
  };

  /* BULK SCAN */
  window.saveBulkScans = async () => {
    const text = bulkInput.value.trim();
    if (!customer.value || !reason.value || !text) {
      alert("Select customer, reason and paste waybills");
      return;
    }

    const lines = text
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l.length >= 8);

    if (!lines.length) {
      alert("No valid waybills found");
      return;
    }

    const date = todayKey();
    const now = Date.now();

    for (const waybill of lines) {
      const scanData = {
        customer: customer.value,
        reason: reason.value,
        waybill,
        date,
        timestamp: now
      };
      await push(ref(db, "scans"), scanData);
      currentData.push(scanData);
    }

    renderList(currentData);
    bulkInput.value = "";

    beep.play();
    document.body.classList.add("flash");
    setTimeout(() => document.body.classList.remove("flash"), 200);
  };
</script>
</head>

<body>

<center>
<img src="https://res.cloudinary.com/dwxgkbuln/image/upload/v1750675472/pakisa_logistics_express_pty_ltd_logo-removebg-preview_kbuvzs.png" width="160">
</center>

<h2>Floor Check</h2>

<label>Customer</label>
<select id="customer">
  <option value="">Select Customer</option>
  <option>First Freight Couriers</option>
  <option>Fedex Express</option>
  <option>Seabourne Logistics</option>
  <option>AJM</option>
  <option>Brima Logistics</option>
</select>

<label>Reason</label>
<select id="reason">
  <option value="">Select Reason</option>
  <option>Out for delivery</option>
  <option>Nobody home</option>
  <option>Incorrect phone number</option>
  <option>Bad address</option>
  <option>Missing paperwork</option>
  <option>Misroute</option>
</select>

<label>Scan Waybill</label>
<input id="scanInput" placeholder="Scan waybill">

<label>Bulk Waybill Paste (one per line)</label>
<textarea id="bulkInput" placeholder="Paste waybills here, one per line"></textarea>

<button onclick="saveBulkScans()">Bulk Upload</button>

<h3>View by Date</h3>
<input type="date" id="dateFilter" onchange="changeDate()">

<h3>Search</h3>
<input id="searchInput" placeholder="Searchâ€¦" onkeyup="filterSearch()">

<h3>Scans</h3>
<div id="scanList"><i>Loadingâ€¦</i></div>

<br><br>
<center><b>Built by Mpho Mahlaba</b></center>

</body>
</html>
