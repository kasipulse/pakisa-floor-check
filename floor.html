<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pakisa Floor Check</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding:20px;
  background:#fff;
}

select,
input,
textarea,
button {
  width:100%;
  padding:12px;
  margin:8px 0;
  font-size:16px;
  box-sizing:border-box;
}

select { touch-action: manipulation; }

textarea {
  min-height:120px;
  resize:vertical;
}

button {
  background:#0a2b52;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.list-item {
  padding:10px;
  background:#f2f2f2;
  margin:6px 0;
  border-radius:8px;
}

.flash {
  background:#2ecc71 !important;
  transition: background 0.2s;
}
</style>

<audio id="beep">
  <source src="https://www.soundjay.com/buttons/sounds/button-09.mp3">
</audio>

<script type="module">
const companyId = localStorage.getItem("companyId");
const companyName = localStorage.getItem("companyName");
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getDatabase,
  ref,
  push,
  onValue,
  query,
  orderByChild,
  startAt,
  update
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBh-KhkmZrS6b97MPv-YTMjU6qTF0qFzbY",
  authDomain: "pakisa-floor.firebaseapp.com",
  databaseURL: "https://pakisa-floor-default-rtdb.firebaseio.com/",
  projectId: "pakisa-floor"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
let customer, reason, scanInput, bulkInput, scanList, beep;
let currentData = [];

/* Helpers */
function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function startOfTodayTs() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.getTime();
}

/* Scanner debounce */
let lastScanTime = 0;

window.addEventListener("DOMContentLoaded", () => {
  customer  = document.getElementById("customer");
  reason    = document.getElementById("reason");
  scanInput = document.getElementById("scanInput");
  bulkInput = document.getElementById("bulkInput");
  scanList  = document.getElementById("scanList");
  beep      = document.getElementById("beep");

  const searchInput = document.getElementById("searchInput");

  listenForScans();
  scanInput.focus();

  /* âœ… Scanner-safe Enter */
  scanInput.addEventListener("keyup", e => {
    if (e.key !== "Enter") return;

    const now = Date.now();
    if (now - lastScanTime < 300) return;
    lastScanTime = now;

    e.preventDefault();
    saveScan();
  });

  /* ðŸš« Search must NEVER trap scanner */
  searchInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      scanInput.focus();
    }
  });

  searchInput.addEventListener("blur", () => {
    setTimeout(() => scanInput.focus(), 50);
  });
});

/* ðŸ”¥ LISTENER â€” TODAY ONLY */
function listenForScans() {
  const q = query(
    ref(db, "scans"),
    orderByChild("timestamp"),
    startAt(startOfTodayTs())
  );

  onValue(q, snap => {
    currentData = [];
    snap.forEach(c => currentData.push(c.val()));
    currentData.sort((a,b) => b.timestamp - a.timestamp);
    renderList(currentData);
  });
}

/* Render list */
function renderList(arr) {
  scanList.innerHTML = "";

  if (!arr.length) {
    scanList.innerHTML = "<i>No scans for today</i>";
    return;
  }

  arr.slice(0,200).forEach(d => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `<b>${d.waybill}</b><br>${d.customer} â€” ${d.reason}`;
    scanList.appendChild(div);
  });
}

/* Search */
window.filterSearch = () => {
  const t = document.getElementById("searchInput").value.toLowerCase();
  renderList(
    currentData.filter(d =>
      d.waybill.toLowerCase().includes(t) ||
      d.customer.toLowerCase().includes(t) ||
      d.reason.toLowerCase().includes(t)
    )
  );
};

/* âœ… SINGLE SCAN (UNCHANGED) */
window.saveScan = async () => {
  const waybill = scanInput.value.trim();
  if (!customer.value || !reason.value || !waybill) {
    scanInput.focus();
    return;
  }

  await push(ref(db, "scans"), {
  companyId,              // ðŸ”‘ THIS IS THE KEY
  companyName,
  customer: customer.value,
  reason: reason.value,
  waybill,
  date: todayKey(),
  timestamp: Date.now()
});

  beep.currentTime = 0;
  beep.play();

  document.body.classList.add("flash");
  setTimeout(() => document.body.classList.remove("flash"), 150);

  scanInput.value = "";
  scanInput.focus();
};

/* ðŸš€ BULK UPLOAD â€” FAST + SAFE (ONLY FIX) */
window.saveBulkScans = async () => {
  const text = bulkInput.value.trim();
  if (!customer.value || !reason.value || !text) {
    alert("Select customer, reason and paste waybills");
    return;
  }

  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length >= 8);
  if (!lines.length) return alert("No valid waybills");

  const updates = {};
  const baseRef = ref(db, "scans");

  lines.forEach(waybill => {
    const key = push(baseRef).key;
    updates[`scans/${key}`] = {
      customer: customer.value,
      reason: reason.value,
      waybill,
      date: todayKey(),
      timestamp: Date.now()
    };
  });

  await update(ref(db), updates);

  bulkInput.value = "";
  beep.play();
};
</script>
</head>

<body>

<center>
<img src="https://res.cloudinary.com/dwxgkbuln/image/upload/v1750675472/pakisa_logistics_express_pty_ltd_logo-removebg-preview_kbuvzs.png" width="160">
</center>

<h2>Floor Check</h2>

<label>Customer</label>
<select id="customer">
  <option value="">Select Customer</option>
  <option>First Freight Couriers</option>
  <option>Fedex Express</option>
  <option>AJM</option>
  <option>Brima Logistics</option>
  <option>Seabourne Logistics</option>
</select>

<label>Reason</label>
<select id="reason">
  <option value="">Select Reason</option>
  <option>Out for delivery</option>
  <option>Nobody home</option>
  <option>Incorrect phone number</option>
  <option>Bad address</option>
  <option>Missing paperwork</option>
  <option>Misroute</option>
  <option>Will be attempted on commitment date</option>
  <option>Future delivery</option>
</select>

<label>Scan Waybill</label>
<input id="scanInput" placeholder="Scan waybill" autocomplete="off">

<label>Bulk Waybill Paste</label>
<textarea id="bulkInput" placeholder="One waybill per line"></textarea>

<button onclick="saveBulkScans()">Bulk Upload</button>

<h3>Search</h3>
<input id="searchInput" placeholder="Searchâ€¦" onkeyup="filterSearch()">

<h3>Scans (Today)</h3>
<div id="scanList"><i>Loadingâ€¦</i></div>

<br>
<center><b>Built by Mpho Mahlaba</b></center>

</body>
</html>
