<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Floor Check</title>

<style>
  body {
    font-family: system-ui, Arial;
    padding: 20px;
    background: #ffffff;
    transition: background-color 0.15s ease;
    color:#1f2937;
  }

  select, input, button {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    font-size: 15px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
  }

  button {
    cursor: pointer;
    background:#0f99da;
    color:white;
    border:none;
  }

  .list-item {
    padding: 12px;
    background: #f9fafb;
    margin: 6px 0;
    border-radius: 10px;
    font-size:14px;
  }

  .flash-green { background:#2ecc71 !important; }
  .flash-red { background:#e74c3c !important; }
  .flash-amber { background:#f1c40f !important; }

  .last-scan {
    background:#eef6ff;
    padding:12px;
    border-radius:12px;
    margin-bottom:15px;
    font-size:14px;
  }

  .admin-only { display:none; }
</style>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg">
</audio>
<audio id="beep2">
  <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getDatabase, ref, push, onValue, query, orderByChild, equalTo
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBh-KhkmZrS6b97MPv-YTMjU6qTF0qFzbY",
    authDomain: "pakisa-floor.firebaseapp.com",
    projectId: "pakisa-floor",
    storageBucket: "pakisa-floor.firebasestorage.app",
    messagingSenderId: "1003516506618",
    appId: "1:1003516506618:web:777d702f93616b6e323443",
    databaseURL: "https://pakisa-floor-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const ADMIN_EMAILS = [
    "ops1@pakisalogistics.co.za",
    "ops2@pakisalogistics.co.za",
    "csd@pakisalogistics.co.za",
    "csd1@pakisalogistics.co.za"
  ];

  let currentData = [];
  let scanLock = false;

  function todayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  window.onload = () => {
    loadScans(todayKey());
    scanInput.focus();
  };

  function loadScans(dateKey) {
    const q = query(ref(db, "scans"), orderByChild("date"), equalTo(dateKey));
    onValue(q, snap => {
      currentData = [];
      snap.forEach(c => currentData.push(c.val()));
      renderList(currentData);
    });
  }

  function renderList(arr) {
    scanList.innerHTML = "";
    arr.forEach(d => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `<b>${d.waybill}</b><br>${d.customer} — ${d.reason}`;
      scanList.appendChild(div);
    });
  }

  function flash(cls) {
    document.body.classList.add(cls);
    setTimeout(()=>document.body.classList.remove(cls),150);
  }

  function updateLastScan(d) {
    lastScan.innerHTML =
      `<b>Last Scan:</b> ${d.waybill}<br>${d.customer} — ${d.reason}<br><small>${new Date().toLocaleTimeString()}</small>`;
  }

  window.saveScan = () => {
    if (scanLock || scanInput.disabled) return;
    scanLock = true;

    const customer = customerEl.value;
    const reason = reasonEl.value;
    const waybill = scanInput.value.trim();

    if (!customer || !reason || !waybill) {
      flash("flash-red");
      scanLock=false; scanInput.focus(); return;
    }

    const duplicate = currentData.find(d => d.waybill === waybill);

    push(ref(db,"scans"),{ customer, reason, waybill, date:todayKey(), timestamp:Date.now() });

    duplicate ? (beep2.play(), flash("flash-amber")) : (beep.play(), flash("flash-green"));

    updateLastScan({ customer, reason, waybill });

    scanInput.value = "";
    setTimeout(()=>{ scanInput.focus(); scanLock=false; },20);
  };

  window.filterSearch = () => {
    const t = searchInput.value.toLowerCase();
    renderList(currentData.filter(d =>
      d.waybill.toLowerCase().includes(t) ||
      d.customer.toLowerCase().includes(t) ||
      d.reason.toLowerCase().includes(t)
    ));
  };

  window.changeDate = () => loadScans(dateFilter.value);

  onAuthStateChanged(auth, user => {
    const editable = user && ADMIN_EMAILS.includes(user.email);
    [customerEl, reasonEl, scanInput].forEach(el => el.disabled = !editable);
    document.querySelectorAll(".admin-only").forEach(el => el.style.display = editable ? "block" : "none");
  });

  window.adminLogin = () =>
    signInWithEmailAndPassword(auth, adminEmail.value, adminPass.value)
      .catch(e=>alert("Login failed"));
</script>
</head>

<body>

<center>
<img src="https://res.cloudinary.com/dwxgkbuln/image/upload/v1750675472/pakisa_logistics_express_pty_ltd_logo-removebg-preview_kbuvzs.png" width="140">
</center>

<div class="admin-only">
  <input id="adminEmail" placeholder="Admin email">
  <input id="adminPass" type="password" placeholder="Password">
  <button onclick="adminLogin()">Pakisa Agent Login</button>
</div>

<div id="lastScan" class="last-scan">Waiting for first scan…</div>

<select id="customerEl">
  <option value="">Select Customer</option>
  <option>First Freight Couriers</option>
  <option>Fedex Express</option>
  <option>Seabourne Logistics</option>
  <option>AJM</option>
  <option>Brima Logistics</option>
</select>

<select id="reasonEl">
  <option value="">Select Reason</option>
  <option>Nobody home</option>
  <option>Incorrect phone number</option>
  <option>Bad address</option>
  <option>Missing paperwork</option>
  <option>Misroute</option>
  <option>Customer refused shipment</option>
  <option>Will be delivered on commitment date</option>
  <option>Voicemail / consignee not available</option>
</select>

<input id="scanInput" placeholder="Scan waybill" onkeydown="if(event.key==='Enter') saveScan()">

<input type="date" id="dateFilter" onchange="changeDate()">
<input id="searchInput" placeholder="Search…" onkeyup="filterSearch()">

<div id="scanList"></div>

<center><b>Built by Mpho Mahlaba</b></center>
</body>
</html>
